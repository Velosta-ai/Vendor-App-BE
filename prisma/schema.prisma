generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BikeStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
}

enum BookingStatus {
  UPCOMING
  ACTIVE
  RETURNED
  CANCELLED
}

enum Role {
  ADMIN
  MANAGER
  STAFF
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  BANK_TRANSFER
}

enum FuelLevel {
  FULL
  THREE_QUARTER
  HALF
  QUARTER
  LOW
}

//
// ─── ORGANIZATION & ACCOUNTS ───────────────────────────────────────────
//

model Organization {
  id          String    @id @default(uuid())
  name        String
  plan        String    @default("free") // free, basic, premium
  bikesLimit  Int       @default(10)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  inviteCode  String    @unique
  accounts    Account[]
  bikes       Bike[]
  bookings    Booking[]
  leads       Lead[]
}

model Account {
  id             String        @id @default(uuid())
  name           String
  email          String        @unique
  passwordHash   String
  role           Role          @default(STAFF)
  phone          String?
  fcmToken       String?       // For push notifications
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  isActive       Boolean       @default(true)

  organization   Organization  @relation(fields: [organizationId], references: [id])
  organizationId String

  refreshTokens  RefreshToken[]
  passwordResets PasswordReset[]
}

//
// ─── AUTH TOKENS ───────────────────────────────────────────────────────
//

model RefreshToken {
  id          String    @id @default(uuid())
  token       String    @unique
  accountId   String
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime  @default(now())
  revokedAt   DateTime?
  replacedBy  String?   // ID of the token that replaced this one (for rotation)

  @@index([accountId])
  @@index([token])
}

model BlacklistedToken {
  id          String    @id @default(uuid())
  token       String    @unique
  expiresAt   DateTime  // When the original token expires (for cleanup)
  createdAt   DateTime  @default(now())

  @@index([token])
  @@index([expiresAt])
}

model PasswordReset {
  id          String    @id @default(uuid())
  otp         String
  accountId   String
  account     Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([accountId])
  @@index([otp])
}

//
// ─── BIKE RENTAL MODULE ───────────────────────────────────────────────
//

model Bike {
  id                 String      @id @default(uuid())
  name               String
  model              String?
  registrationNumber String      @unique
  year               Int?
  dailyRate          Float
  status             BikeStatus  @default(AVAILABLE)
  images             String[]    @default([])
  isDeleted          Boolean     @default(false)
  deletedAt          DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  organization       Organization @relation(fields: [organizationId], references: [id])
  organizationId     String

  bookings           Booking[]
  documents          BikeDocument[]
  maintenanceLogs    MaintenanceLog[]

  @@index([organizationId])
  @@index([status])
}

model BikeDocument {
  id          String    @id @default(uuid())
  bikeId      String
  bike        Bike      @relation(fields: [bikeId], references: [id], onDelete: Cascade)
  type        String    // RC, INSURANCE, PUC, etc.
  url         String
  expiryDate  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([bikeId])
  @@index([expiryDate])
}

model MaintenanceLog {
  id          String    @id @default(uuid())
  bikeId      String
  bike        Bike      @relation(fields: [bikeId], references: [id], onDelete: Cascade)
  type        String    // SERVICE, REPAIR, INSPECTION, etc.
  description String?
  cost        Float     @default(0)
  date        DateTime  @default(now())
  notes       String?
  createdAt   DateTime  @default(now())

  @@index([bikeId])
  @@index([date])
}

model Booking {
  id            String        @id @default(uuid())
  customerName  String
  phone         String
  startDate     DateTime
  endDate       DateTime
  totalAmount   Float
  paidAmount    Float
  notes         String?
  status        BookingStatus @default(UPCOMING)
  
  // Payment tracking
  paymentMethod PaymentMethod?
  paymentNotes  String?
  
  // ─── DELIVERY DETAILS (when bike is handed over) ───
  helmetsGiven      Int?          // Number of helmets given
  fuelLevelStart    FuelLevel?    // Fuel level at delivery
  odometerStart     Float?        // KM reading at delivery
  existingDamages   String?       // Notes about existing scratches/damages
  deliveredAt       DateTime?     // When bike was delivered
  deliveredById     String?       // Staff who delivered
  idVerified        Boolean       @default(false) // Customer ID verified
  securityDeposit   Float?        // Security deposit collected
  
  // ─── RETURN DETAILS (when bike is returned) ───
  helmetsReturned   Int?          // Number of helmets returned
  fuelLevelEnd      FuelLevel?    // Fuel level at return
  odometerEnd       Float?        // KM reading at return
  newDamages        String?       // Any new damages found
  returnedAt        DateTime?     // When bike was returned
  receivedById      String?       // Staff who received
  fuelCharge        Float?        // Charge for fuel difference
  damageCharge      Float?        // Charge for damages
  extraKmsCharge    Float?        // Charge for extra KMs (if applicable)
  lateFee           Float?        // Late return fee
  
  // Soft delete
  isDeleted     Boolean       @default(false)
  deletedAt     DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  bike          Bike          @relation(fields: [bikeId], references: [id])
  bikeId        String

  organization  Organization  @relation(fields: [organizationId], references: [id])
  organizationId String
  
  payments      Payment[]

  @@index([organizationId])
  @@index([bikeId])
  @@index([status])
  @@index([startDate, endDate])
}

model Payment {
  id          String        @id @default(uuid())
  bookingId   String
  booking     Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  amount      Float
  method      PaymentMethod
  date        DateTime      @default(now())
  notes       String?
  createdAt   DateTime      @default(now())

  @@index([bookingId])
}

model Lead {
  id            Int           @id @default(autoincrement())
  phone         String
  message       String?
  source        String        @default("manual")
  status        String        @default("new") // new, contacted, in_progress, converted, lost
  timestamp     DateTime      @default(now())

  organization  Organization  @relation(fields: [organizationId], references: [id])
  organizationId String

  @@index([organizationId])
  @@index([status])
}

//
// ─── AUDIT LOG ─────────────────────────────────────────────────────────
//

model AuditLog {
  id          String    @id @default(uuid())
  action      String    // CREATE, UPDATE, DELETE, LOGIN, LOGOUT, etc.
  entityType  String    // BIKE, BOOKING, ACCOUNT, etc.
  entityId    String?
  accountId   String?
  organizationId String
  changes     Json?     // JSON diff of changes
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime  @default(now())

  @@index([organizationId])
  @@index([accountId])
  @@index([entityType, entityId])
  @@index([createdAt])
}
